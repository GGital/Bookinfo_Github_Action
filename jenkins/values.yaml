controller:
  # 1. Autopilot-compatible Networking
  serviceType: NodePort
  healthCheckPath: "/login"
  
  javaOpts: "-Dhudson.security.csrf.DefaultCrumbIssuer.EXCLUDE_SESSION_ID=true"
  
  # 2. Add an Init Script to enable Proxy Compatibility
  initScripts:
    - |
      import jenkins.model.Jenkins
      import hudson.security.csrf.DefaultCrumbIssuer

      def instance = Jenkins.instance
      if (instance.getCrumbIssuer() == null) {
          instance.setCrumbIssuer(new DefaultCrumbIssuer(true)) // 'true' enables proxy compatibility
          instance.save()
          println "CSRF Proxy Compatibility Enabled"
      }

  # 2. External URL Setup
  jenkinsUrl: "https://cicd-gital.opsta.in.th/"
  jenkinsUrlProtocol: "https"

  # 3. Security Context (Autopilot Friendly)
  # We remove 'privileged: true' and 'runAsUser: 0'
  runAsUser: 1000
  fsGroup: 1000
  runAsNonRoot: true
  
  # Ensure the init container does NOT ask for privileges
  initContainer:
    securityContext:
      privileged: false
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      runAsUser: 1000
  
  # 4. Fix for config-reload-init (The error you saw)
  sidecars:
    configAutoReload:
      enabled: true
      containerSecurityContext:
        privileged: false
        allowPrivilegeEscalation: false
        runAsUser: 1000

  # 5. Resources (Autopilot requires specific ratios)
  resources:
    requests:
      cpu: "500m"
      memory: "1024Mi"
    limits:
      cpu: "500m"
      memory: "1024Mi"
  
  admin : 
    createSecret: true

persistence:
  enabled: true
