def scmVars

pipeline { 
    
    agent{
        
        kubernetes { 
            
            yaml"""
apiVersion: v1
kind: Pod
spec: 
    containers:
    - name: docker
      image: docker:20.10.3-dind
      command:
      - dockerd
      - --host=unix:///var/run/docker.sock
      - --host=tcp://0.0.0.0:2375
      - --storage-driver=overlay2
      tty: true
      securityContext:
        privileged: true
    - name: helm
      image: google/cloud-sdk:alpine
      command:
      - cat
      tty: true
    - name: kics
      image: checkmarx/kics:latest
      command:
      - cat
      tty: true
    - name: zap
      image: ghcr.io/zaproxy/zaproxy:stable
      command:
      - cat
      tty: true
    - name: java-node
      image: timbru31/java-node:11-alpine-jre-20
      command:
      - cat
      tty: true
      volumeMounts:
      - mountPath: /home/jenkins/dependency-check-data
        name: dependency-check-data
    volumes:
    - name: dependency-check-data
      hostPath:
        path: /tmp/dependency-check-data

"""

                
        }
    }
    
    // Defining Environment Variables
    environment {
        ENV_NAME = "${BRANCH_NAME == "main" ? "uat" : "${BRANCH_NAME}"}"
        SCANNER_HOME = tool 'sonarqube-scanner'
        PROJECT_KEY = "bookinfo:ratings"
        PROJECT_NAME = "bookinfo:ratings"
    }

    stages{
        
        stage('Clone ratings source code') { 
            when {
                changeset "src/ratings/**"
            }
            steps {
                container('jnlp') {  // jnlp is basic slave to connect with jenkins master
                    script {
                        scmVars = git branch: "${BRANCH_NAME}",
                                      credentialsId: 'bookinfo-git-deploy-key',
                                      url: 'git@gitlab.com:ggital-group/bookinfo.git'
                    } // End script
                } // End container
            } // End steps
        } // End stage
        stage('KICS') { 
            when {
                changeset "src/ratings/**"
            }
            steps {
                container('kics') { 
                    script { 
                        // Move into the ratings directory
                        dir("src/ratings") { 
                            sh 'mkdir -p kics-results'

                            // Run scan. Note: Output path is relative to the current dir (src/ratings)
                            sh 'kics scan -p . --report-formats html --output-path kics-results/ --output-name scan-report --ignore-on-exit results'
                            
                            // ARCHIVE FIX: Use the path relative to the current dir() block
                            archiveArtifacts artifacts: 'kics-results/scan-report.html', fingerprint: true, allowEmptyArchive: true
                            
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                reportDir: 'kics-results',
                                reportFiles: 'scan-report.html',
                                reportName: 'KICS Security Report'
                            ])
                        }
                    }
                }
            }
        }
        stage('Sonarqube') { 
            when {
                changeset "src/ratings/**"
            }
            steps { 
                container('java-node') { 
                    script {
                        dir("./src/ratings") { 
                            withSonarQubeEnv('sonarqube-global') { 
                                // Run Sonar Scanner
                                sh """${SCANNER_HOME}/bin/sonar-scanner \
                                -D sonar.projectKey=${PROJECT_KEY} \
                                -D sonar.projectName=${PROJECT_NAME} \
                                -D sonar.projectVersion=${BRANCH_NAME}-${BUILD_NUMBER} \
                                -D sonar.sources=./src
                                """
                            }

                            timeout(time: 1,unit: 'MINUTES') { 
                                def qg = waitForQualityGate()
                                if (qg.status != 'OK') { 
                                    error "Pipeline aborted due to quality gate failure: ${qg.status}"
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('OWASP Dependency Check') { 
            when {
                changeset "src/ratings/**"
            }
            steps { 
                container('java-node') {
                    script { 
                        dir("./src/ratings") { 

                            //Install application dependency
                            sh """cd src/ && npm install --package-lock && cd .."""
                            
                            //Run dependency Check
                            dependencyCheck(
                                additionalArguments: "--data /home/jenkins/dependency-check-data --out dependency-check-report.xml",
                                odcInstallation: "dependency-check"
                            )

                            //Publish report to Jenkins
                            dependencyCheckPublisher(
                                pattern: "dependency-check-report.xml"
                            )

                            //Remove application dependency
                            sh '''rm -rf src/node_modules src/package-lock.json'''


                        }
                    }
                }
            }
        }

        stage('Build ratings Docker Image and Push') { 
            when {
                changeset "src/ratings/**"
            }
            steps { 
                container('docker') { // docker matches with name in yaml manifest file 
                    dir('src/ratings') { 
                        script { 
                            docker.withRegistry('https://registry-gital.opsta.in.th/' , 'registry-bookinfo') {
                                docker.build("registry-gital.opsta.in.th/bookinfo/ratings:${ENV_NAME}").push()
                                } // End with registry
                            }// End script
                        } // End dir
                    }// End container
                } // End steps
            } // End stage
        stage('Trivy') { 
            when {
                changeset "src/ratings/**"
            }
            steps{
                container('docker') { 
                    sh """
                    # 1. Download the official HTML template to the current workspace
                    wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O trivy-html.tpl

                    # 2. Run Trivy and mount the workspace so it can see the downloaded template
                    docker run --rm \
                        -v /var/run/docker.sock:/var/run/docker.sock \
                        -v \$(pwd):/workspace \
                        aquasec/trivy:latest image \
                        --severity LOW,MEDIUM,HIGH \
                        --format template \
                        --template "@/workspace/trivy-html.tpl" \
                        --output /workspace/trivy-report.html \
                        registry-gital.opsta.in.th/bookinfo/ratings:${ENV_NAME}
                    """

                    archiveArtifacts artifacts: 'trivy-report.html'
                    publishHTML(target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: false,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'trivy-report.html',
                        reportName: 'Trivy Security Report'
                    ])
                }
            }
        }
        stage('Deploy ratings with Helm Chart') { 
            when {
                changeset "src/ratings/**"
            }
            steps {
        container('helm') {
            script { 
                withCredentials([file(credentialsId: 'gke-sa-key-json', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
                    dir('src/ratings') { 
                        sh """
    # 1. Install dependencies for the Helm installer and the GKE Auth Plugin
    # Added openssl for checksum verification and bash to run the installer
    apk add --no-cache curl openssl bash

    # 2. Install Helm
    # Using -s -- -v to pass flags if needed, or simply piping to bash
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | VERIFY_CHECKSUM=false bash

    # 3. Install the GKE Auth Plugin
    gcloud components install gke-gcloud-auth-plugin --quiet

    # 4. CRITICAL: Tell kubectl/helm to use the new GKE plugin
    export USE_GKE_GCLOUD_AUTH_PLUGIN=True

    # 5. Authenticate and Get Credentials
    gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
    
    # Replace with your actual cluster details
    gcloud container clusters get-credentials bookinfo --region asia-southeast1 --project gifted-airport-481410-e7
    
    # 6. Run Helm
    helm upgrade --install \
    -f ./helm_values/values-bookinfo-${ENV_NAME}-ratings.yaml \
    --set extraEnv.COMMIT_ID=${scmVars.GIT_COMMIT} \
    --wait --namespace bookinfo-${ENV_NAME} \
    bookinfo-ratings-${ENV_NAME} ./helm
"""
                    }
                }
            }
        }
    }
}
    stage('OWASP ZAP DAST') { 
            when {
                changeset "src/ratings/**"
            }
            steps {
                container('zap') { // Switch to the dedicated zap container
                    script {
                        sh "mkdir -p zap-results"

                        // Using the official Python wrapper (easier than raw zap.sh)
                        // -t: target URL
                        // -r: report name
                        sh """
                        zap-baseline.py -t https://bookinfo-gital-${ENV_NAME}.opsta.in.th/ \
                            -r zap-report.html
                        
                        # Move the report to our results folder
                        mv /zap/wrk/zap-report.html ./zap-results/
                        """

                        archiveArtifacts artifacts: 'zap-results/zap-report.html', allowEmptyArchive: true
                        
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            reportDir: 'zap-results',
                            reportFiles: 'zap-report.html',
                            reportName: 'OWASP ZAP DAST Report'
                        ])
                    }
                }
            }
        }
        } // End stage
    }
