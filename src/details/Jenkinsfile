def scmVars

pipeline { 
    
    agent{
        
        kubernetes { 
            
            yaml"""
apiVersion: v1
kind: Pod
spec: 
    containers:
    - name: docker
      image: docker:20.10.3-dind
      command:
      - dockerd
      - --host=unix:///var/run/docker.sock
      - --host=tcp://0.0.0.0:2375
      - --storage-driver=overlay2
      tty: true
      securityContext:
        privileged: true
    - name: helm
      image: lachlanevenson/k8s-helm:v3.5.0
      command:
      - cat
      tty: true
    - name: zap
      image: ghcr.io/zaproxy/zaproxy:stable
      command:
      - cat
      tty: true
    - name: kics
      image: checkmarx/kics:latest
      command:
      - cat
      tty: true
    - name: java-node
      image: timbru31/java-node:11-alpine-jre-20
      command:
      - cat
      tty: true
    - name: ruby
      image: ruby:3.1-alpine
      command:
      - cat
      tty: true
      volumeMounts:
      - mountPath: /home/jenkins/dependency-check-data
        name: dependency-check-data
    volumes:
    - name: dependency-check-data
      hostPath:
        path: /tmp/dependency-check-data

"""

                
        }
    }    
    
    // Defining Environment Variables
    environment {
        ENV_NAME = "${BRANCH_NAME == "main" ? "uat" : "${BRANCH_NAME}"}"
        SCANNER_HOME = tool 'sonarqube-scanner'
        PROJECT_KEY = "bookinfo:details"
        PROJECT_NAME = "bookinfo:details"
    }

    stages{
        
        stage('Clone details source code') { 
            when {
                changeset "src/details/**"
            }
            steps {
                container('jnlp') {  // jnlp is basic slave to connect with jenkins master
                    script {
                        scmVars = git branch: "${BRANCH_NAME}",
                                      credentialsId: 'bookinfo-git-deploy-key',
                                      url: 'git@gitlab.com:ggital-group/bookinfo.git'
                    } // End script
                } // End container
            } // End steps
        } // End stage
        stage('KICS') { 
            when {
                changeset "src/details/**"
            }
            steps {
                container('kics') { 
                    script { 
                        // Move into the details directory
                        dir("src/details") { 
                            sh 'mkdir -p kics-results'

                            // Run scan. Note: Output path is relative to the current dir (src/details)
                            sh 'kics scan -p . --report-formats html --output-path kics-results/ --output-name scan-report --ignore-on-exit results'
                            
                            // ARCHIVE FIX: Use the path relative to the current dir() block
                            archiveArtifacts artifacts: 'kics-results/scan-report.html', fingerprint: true, allowEmptyArchive: true
                            
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                reportDir: 'kics-results',
                                reportFiles: 'scan-report.html',
                                reportName: 'KICS Security Report'
                            ])
                        }
                    }
                }
            }
        }
        stage('Sonarqube') { 
            when {
                changeset "src/details/**"
            }
            steps { 
                container('java-node') { 
                    script {
                        dir("./src/details") { 
                            withSonarQubeEnv('sonarqube-global') { 
                                // Run Sonar Scanner
                                sh """${SCANNER_HOME}/bin/sonar-scanner \
                                -D sonar.projectKey=${PROJECT_KEY} \
                                -D sonar.projectName=${PROJECT_NAME} \
                                -D sonar.projectVersion=${BRANCH_NAME}-${BUILD_NUMBER} \
                                -D sonar.sources=.
                                """
                            }

                            timeout(time: 1,unit: 'MINUTES') { 
                                def qg = waitForQualityGate()
                                if (qg.status != 'OK') { 
                                    error "Pipeline aborted due to quality gate failure: ${qg.status}"
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('OWASP Dependency Check') { 
            when {
                changeset "src/details/**"
            }
            steps { 
                container('ruby') {
                    script { 
                        dir("./src/details") { 

                            // Install Java for dependency-check
                            sh 'apk add --no-cache openjdk11-jre'

                            // Install application dependencies
                            sh 'bundle install'
                            
                            // Run dependency Check
                            dependencyCheck(
                                additionalArguments: "--data /home/jenkins/dependency-check-data --out dependency-check-report.xml",
                                odcInstallation: "dependency-check"
                            )

                            // Publish report to Jenkins
                            dependencyCheckPublisher(
                                pattern: "dependency-check-report.xml"
                            )

                            // Remove application dependencies
                            sh 'rm -rf /usr/local/bundle/cache'
                        }
                    }
                }
            }
        }

        stage('Build details Docker Image and Push') { 
            when {
                changeset "src/details/**"
            }
            steps { 
                container('docker') { // docker matches with name in yaml manifest file 
                    dir('src/details') { 
                        script { 
                            docker.withRegistry('https://registry-gital.opsta.in.th/' , 'registry-bookinfo') {
                                docker.build("registry-gital.opsta.in.th/bookinfo/details:${ENV_NAME}").push()
                                } // End with registry
                            }// End script
                        } // End dir
                    }// End container
                } // End steps
            } // End stage
        stage('Trivy') { 
            when {
                changeset "src/details/**"
            }
            steps{
                container('docker') { 
                    sh """
                    # 1. Download the official HTML template to the current workspace
                    wget https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -O trivy-html.tpl

                    # 2. Run Trivy and mount the workspace so it can see the downloaded template
                    docker run --rm \
                        -v /var/run/docker.sock:/var/run/docker.sock \
                        -v \$(pwd):/workspace \
                        aquasec/trivy:latest image \
                        --severity LOW,MEDIUM,HIGH \
                        --format template \
                        --template "@/workspace/trivy-html.tpl" \
                        --output /workspace/trivy-report.html \
                        registry-gital.opsta.in.th/bookinfo/details:${ENV_NAME}
                    """

                    archiveArtifacts artifacts: 'trivy-report.html'
                    publishHTML(target: [
                        allowMissing: false,
                        alwaysLinkToLastBuild: false,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'trivy-report.html',
                        reportName: 'Trivy Security Report'
                    ])
                }
            }
        }
        stage('Deploy details with Helm Chart') { 
            when {
                changeset "src/details/**"
            }
            steps {
        container('helm') {
            script { 
                    dir('src/details') { 
                        sh """
                            helm upgrade --install \
                            -f ./helm_values/values-bookinfo-${ENV_NAME}-details.yaml \
                            --set extraEnv.COMMIT_ID=${scmVars.GIT_COMMIT} \
                            --wait --namespace bookinfo-${ENV_NAME} \
                            bookinfo-details-${ENV_NAME} ./helm
                        """
                        }
                    }
                }
            }
        }
        stage('OWASP ZAP DAST') { 
            when {
                changeset "src/ratings/**"
            }
            steps {
                container('zap') { 
                    script {
                        sh """
                        ln -s \$(pwd) /zap/wrk

                        zap-baseline.py -t https://bookinfo-gital-${ENV_NAME}.opsta.in.th/ \
                            -r zap-report.html || [ \$? -eq 2 ]
                        """

                        archiveArtifacts artifacts: 'zap-report.html', fingerprint: true, allowEmptyArchive: true
                        
                        publishHTML([
                            allowMissing: false,
                            alwaysLinkToLastBuild: true,
                            reportDir: '.',
                            reportFiles: 'zap-report.html',
                            reportName: 'OWASP ZAP DAST Report'
                        ])
                    }
                }
            }
        }
        } // End stage
    }